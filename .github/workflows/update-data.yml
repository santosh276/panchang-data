name: Sync & Clean Google Doc Data

on:
  schedule:
    # Runs every 6 hours (at 00:00, 06:00, 12:00, 18:00 UTC)
    - cron: '0 */6 * * *'
  # Allows you to click "Run workflow" manually
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update-calendar-data:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: Install JSDOM
        run: npm install jsdom node-fetch

      - name: Fetch and Clean Data
        env:
          # REPLACE THIS LINK WITH YOUR GOOGLE DOC '/pub' LINK
          DOC_URL: "https://docs.google.com/document/d/e/2PACX-1vQDexcd-amo5HoDI3CmBpRfwmmuYgrruS6WGG1cTxK3vJ4sdcYdebFAz4SKGG4H6dkSWSm5eBwHlXcH/pub"
        run: |
          node -e "
          const fs = require('fs');
          const { JSDOM } = require('jsdom');

          // --- SMART FETCH FUNCTION (Retry Logic) ---
          async function fetchWithRetry(url, retries = 3, delay = 5000) {
            for (let i = 0; i < retries; i++) {
              try {
                console.log('Fetching Google Doc (Attempt ' + (i + 1) + ')...');
                const response = await fetch(url);
                if (!response.ok) throw new Error('Status: ' + response.status);
                return await response.text();
              } catch (err) {
                console.log('Attempt ' + (i + 1) + ' failed: ' + err.message);
                if (i === retries - 1) throw err; // If last attempt fails, crash
                console.log('Waiting 5 seconds before trying again...');
                await new Promise(res => setTimeout(res, delay));
              }
            }
          }

          async function run() {
            try {
              // Use the smart fetch instead of standard fetch
              const html = await fetchWithRetry(process.env.DOC_URL);

              console.log('Parsing and Cleaning HTML...');
              const dom = new JSDOM(html);
              const doc = dom.window.document;

              // 1. Remove Unwanted Tags
              const unwanted = doc.querySelectorAll('style, script, link, meta, title, noscript, svg');
              unwanted.forEach(el => el.remove());

              // 2. Remove Google Headers/Footers
              const header = doc.querySelector('#header'); if(header) header.remove();
              const footer = doc.querySelector('#footer'); if(footer) footer.remove();

              // 3. Custom Text Extractor (Preserves Newlines)
              function getText(node) {
                if (node.nodeType === 3) return node.nodeValue; // Text Node
                if (node.nodeType === 1) { // Element Node
                  let text = '';
                  for (let child of node.childNodes) {
                    text += getText(child);
                  }
                  const tag = node.tagName.toLowerCase();
                  if (['p', 'div', 'br', 'li', 'tr', 'h1', 'h2', 'h3', 'h4', 'h5'].includes(tag)) {
                    text += '\n';
                  }
                  return text;
                }
                return '';
              }

              // Extract from main content
              const contentNode = doc.querySelector('#contents') || doc.body;
              let cleanText = getText(contentNode);

              // 4. Formatting Cleanup (Remove excess blank lines)
              cleanText = cleanText.replace(/\n\s*\n/g, '\n\n').trim();
              
              console.log('Saving to calendar_data.txt...');
              fs.writeFileSync('calendar_data.txt', cleanText);
              console.log('Success! Data saved.');

            } catch (error) {
              console.error('Final Error:', error);
              process.exit(1);
            }
          }
          run();
          "

      - name: Commit and Push if Changed
        run: |
          git config user.name "Panchang Bot"
          git config user.email "actions@github.com"
          git add calendar_data.txt
          # Check if file changed before committing
          git diff --quiet && git diff --staged --quiet || (git commit -m "Auto-update clean calendar data" && git push)
